<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/mainStyleSheet.css">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>


<body style="margin: 0;">
	<center>
		<h1 id="welcome_text" class="genres_text"></h1>
        <input type="button" value="Reset Account" onclick="reset_account()">
        <p class="normal_white_text">NOTE:<br> If you rate any movies on the frontpage, you must refresh the frontpage to see any changes. <br>
        The reset button will remove all ratings from your account and transfer you back to the login page.</p>
	</center>
	

	<div id="background" class="background">

	</div>

	<div class="rating">
	
	</div>
	

	<script>
		let socket = io();

		let my_user;
		let all_genres = ["Horror", "Action", "Romance", "Comedy", "Western", "Fantasy", "Thriller", "Musical", "Sci-Fi", "Children", "Animation", 
			"Documentary", "Mystery", "Adventure", "Drama", "Crime"];
		let all_liked_genres = [];

		//Loads array of all movies when the server is on, 
		let all_movies = [];
		socket.on("send_movie_array", function(data) {
			all_movies = data;
		});

		socket.emit("get data", read_cookie("id"));

		socket.on("send data", function(user_data) {
			all_movies = user_data.movies;
			my_user = user_data;


			//Add all liked genres to all_liked_genres array. 
			for(let i = 0; i < my_user.liked_genres.length; i++) {
				if(my_user.liked_genres[i].liked == 1) {
					all_liked_genres.push(my_user.liked_genres[i].name);
				}
			}
			document.getElementById("welcome_text").innerHTML = "Welcome " + user_data.name;
			personalize_page();

		});

		//puts movies with the correct genre under der correct header, uses data array function to find specific genre
		 //function that creates our movie thumbnail and adds a overlay on mouse hover that shoves movie name and star rating feature.
	function create_elements(main_element, i, curr_movies) {
		if(curr_movies[i] != undefined) {
				let category_section = document.getElementById(main_element);
				
				let movie_container = document.createElement("div");
				let movie_image = document.createElement("img");
				let movie_overlay = document.createElement("div");
				let movie_title_text = document.createElement("div");
				let movie_MovieId = document.createElement("div");
				let star_ratings = document.createElement("div");
				let textnode = document.createElement("div");

				//loop that creates clickable rating-stars under each movie overlay (used in conjunction with star_label)
				for(let j = 1; j < 6; j++) {
					let star_input = document.createElement("input");
					star_input.type = "radio";
					star_input.name = "star";
					star_input.id = "star" + j;
					
					//loop that gives correct rating value for each star 
					for(let k = 5; k >= 1; k--) {
						star_input.value = k - j + 5;
						//all_movies[i].rating = star_input.value;
					}

					//registers the users vote based on the amount of stars given and saves them in rating document file.
					let star_label = document.createElement("label");
					star_label.onclick = function(){
						console.log(curr_movies[i].title);
						console.log(curr_movies[i].movieId);
						console.log(star_input.value);
						textnode.innerHTML = "You have rated this movie " + star_input.value + "/5 stars";
						star_ratings.append(textnode);
						star_ratings.replaceWith(textnode);
						movie_overlay.append(textnode);
						socket.emit("rating movie on frontpage", curr_movies[i], read_cookie("id"), star_input.value);

					};

					star_ratings.appendChild(star_input);
					star_ratings.appendChild(star_label);
				}

                //
				category_section.appendChild(movie_container);
				movie_container.appendChild(movie_overlay);
				movie_container.appendChild(movie_image);
				movie_overlay.appendChild(movie_title_text);
				movie_overlay.appendChild(star_ratings);
				movie_overlay.appendChild(movie_MovieId);
				movie_overlay.append(textnode);


				//assigns names under each class.
				movie_container.className = "movie_container";
				movie_overlay.className = "movie_overlay";
				movie_title_text.className = "movie_title_text";
				movie_image.className = "movie_images";
				movie_MovieId.className = "id";
				star_ratings.className = "rating";
				textnode.className = "textnode";
				

				movie_title_text.innerHTML = curr_movies[i].title;
				movie_MovieId.innerHTML = curr_movies[i].movieId;

				//ensures that if a movie has no thumbnail is given a placeholder 
				if(curr_movies[i].poster_img != "https://image.tmdb.org/t/p/w600_and_h900_bestv2null") {
				movie_image.src = curr_movies[i].poster_img;
				}else{
				movie_image.src = "https://cdn.discordapp.com/attachments/674212911996207127/707153026049376286/oracal-651g-intermediate-cal-dark-green-folie-i-63-126-cm-s-bredde.jpg.png";
				}
		}
	}	

	function read_cookie(name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
		}
		
	function personalize_page () {
		create_category_divs(1);
		create_category_divs(0);

			for(let i = 0; i < all_genres.length; i++) {
				let curr_movies = sort_movies_by_genres_and_ratings(all_genres[i]);
				for(let j = 0; j < 20; j++) {
					create_elements(all_genres[i],j,curr_movies);
				}
			}
	}

	function create_category_divs(liked_or_not) {
		for(let i = 0; i < my_user.liked_genres.length; i++) {
			if(my_user.liked_genres[i].liked === liked_or_not) {
				let main_div = document.createElement("div");
				let headline = document.createElement("h2");
				let sub_div = document.createElement("div");

				document.getElementById("background").appendChild(main_div);
				main_div.appendChild(headline);
				main_div.appendChild(sub_div);

				headline.className = "genres_text";
				sub_div.className = "movie_section";

				sub_div.id = my_user.liked_genres[i].name;

				headline.innerHTML = my_user.liked_genres[i].name;
			}
		}
	}

	function sort_movies_by_genres_and_ratings(genre) {
		let new_movie_array = [];
		
		for(let i = 0; i < all_movies.length; i++) {
			if(all_movies[i].genres.includes(genre)) {
				let new_movie = all_movies[i];
				new_movie.score = 0;
				for(let j = 0; j < all_liked_genres.length; j++) {
					if(all_movies[i].genres.includes(all_liked_genres[j])) {
						new_movie.score++;
					}
				}
				new_movie.score += new_movie.rating;
				new_movie_array.push(new_movie);
			}
		}
		
		new_movie_array.sort((a,b) => (a.score < b.score) ? 1 : -1 );
		return new_movie_array;
	}

	function reset_account () {
		location.href="/";
		socket.emit("reset account", read_cookie("id"));
	}

	</script>


<!-- 
	VORES KODE TIL GRAFEN!!!
<div id="yo"></div>

<script src="https://www.gstatic.com/charts/loader.js"></script>

<script>
google.charts.load('44', {
    callback: drawBackgroundColor,
    packages: ['corechart']
  });
  
  function drawBackgroundColor() {
	setTimeout(() => {
	
	let c = [];
	for(let i = 300; i < 400; i++) {
		c.push([i,my_user.ratings[0][i]]);
	}
	console.log(c);
  
    var data = new google.visualization.DataTable();
    data.addColumn('number', 'Date');
    data.addColumn('number', 'Distance');
  
    data.addRows(c);
  
    var options = {
      hAxis: {
        title: 'Time'
      },
      vAxis: {
        title: 'Popularity'
      },
      backgroundColor: '#f1f8e9'
    };
  
    var chart = new google.visualization.LineChart(document.getElementById('yo'));
    chart.draw(data, options);
	}, 5000);
	
  }
</script>
-->



</body>

</html>